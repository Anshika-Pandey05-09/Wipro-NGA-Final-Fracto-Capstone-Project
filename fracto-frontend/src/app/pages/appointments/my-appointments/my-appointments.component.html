<div class="container py-3">
  <h4 class="mb-3">My Appointments</h4>

  <div *ngIf="loading" class="text-center my-4"><div class="spinner-border"></div></div>
  <div *ngIf="!loading && error" class="alert alert-danger">{{ error }}</div>

  <div *ngIf="!loading && !error">
    <div class="row g-3">
      <div class="col-12" *ngFor="let a of rows; trackBy: trackById">
        <div class="card shadow-sm border-0">
          <div class="card-body d-flex">
            <img [src]="imgUrl(a.doctorProfileImagePath)"
                 class="rounded border me-3"
                 style="width:64px;height:64px;object-fit:cover;"/>

            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ a.doctorName }}</div>
                  <div class="small text-muted">{{ a.city }}</div>
                </div>
                <span [class]="statusClass(a.status)">{{ a.status }}</span>
              </div>
              <div class="mt-2 text-muted">
                <span>{{ a.appointmentDate | date:'mediumDate' }}</span>
                <span class="ms-2"><code>{{ a.timeSlot }}</code></span>
              </div>

              <!-- Actions -->
              <div class="mt-2 d-flex gap-2">
                <button *ngIf="canCancel(a)"
                        class="btn btn-sm btn-outline-danger"
                        (click)="cancel(a)">
                  Cancel
                </button>

                <button *ngIf="canRate(a) && ratingFor !== a.id"
                        class="btn btn-sm btn-outline-primary"
                        (click)="startRate(a)">
                  Rate doctor
                </button>
              </div>

              <!-- Rating inline form -->
              <div *ngIf="ratingFor === a.id" class="mt-2 p-2 border rounded bg-light">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                  <label class="me-2 mb-0">Your rating:</label>
                  <select class="form-select form-select-sm" style="width:auto" [(ngModel)]="ratingValue">
                    <option *ngFor="let s of [5,4,3,2,1]" [value]="s">{{ s }} ★</option>
                  </select>
                  <input class="form-control form-control-sm" style="max-width: 300px;"
                         placeholder="Optional note" [(ngModel)]="ratingNote" />
                  <button class="btn btn-sm btn-success" (click)="submitRate(a)">Submit</button>
                  <button class="btn btn-sm btn-outline-secondary" (click)="cancelRate()">Close</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="!rows?.length" class="col-12">
        <div class="text-center text-muted py-5">You don’t have any appointments yet.</div>
      </div>
    </div>
  </div>
</div>
